## 项目结构

```shell
├───app # 服务目录
│   └───fileserver
│       ├───api
│       ├───model
│       └───rpc
├───common  # 公共模块
└───deploy  # 部署
    ├───compose  # compose 部署
    └───k8s      # k8s 部署
```

## 中间件部署

### mysql

k8s 集群部署方式，mysql 采用一主两从的方式部署，主节点向外暴露3306端口，从节点只读向外暴露3307端口。因此可以采用读写分离的模式，访问3306端口写，3307端口读。

#### 技术细节

mysql 清单，master_init.sh、slave_init.sh 脚本用于主节点的初始化，放在 /docker-entrypoint-initdb.d/ 目录下面，mysql 容器的
entrypoint 脚本执行完之后会执行这里面的脚本，而且容器只会在第一次初始化的时候执行。

### redis

redis 采用一主两从，三哨兵的方式部署，使用的时候通过哨兵的地址连接。通过 ip:16379 端口连接哨兵，哨兵会返回当前主节点的地址。

#### 技术细节

在这里有个细节就是，redis 三个 pod 用 30040、30041、30042 三个不同的端口向外暴露服务，这样做的好处是避免 NodePort
负载均衡机制将哨兵返回的主节点地址负载到从节点上。

### minio

### kafka

## 端口规划

| 服务   | 端口    |
|------|-------|
| 网关服务 | 41000 |
| 文件服务 | 41001 |
| 用户服务 | 41002 |

## 文件服务

文件服务提供文件上传、下载、删除、文件列表功能，文件上传、下载、删除功能都使用 multipart/form-data 方式上传，文件列表功能返回文件列表。

### 技术方案

1. 前端实现分片上传功能，
    1. 前端上传前先请求获取uploadID，上传文件的hash和大小，文件类型，文件名，分片数量等等信息
    2. 后端调用rpc服务，请求minio生成uploadID
    3. 前端开始对文件进行分片，并且上传分片，后端api通过rpc流进行文件传输，rpc服务将文件上传minio
    4. 所有分片上传之后看需不需要计算一下hash值，需要对比大小和hash值，如果两个对不上，说明文件损坏了
2. 断点续传以及秒传实现
    1. 断点续传的原理是将已经上传的分片etag保存到某个地方，跳过已经上传的，秒传的原理差不多